<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>프리네가족팀 남경 여행 - 온라인 숙지현황</title>

<!-- Tailwind CDN -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Fonts & Icons -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
  body{font-family:'Inter','Noto Sans KR',sans-serif;background:#f7fafc;}
  .accordion-header{cursor:pointer;}
  .accordion-header .icon{transition:transform .3s ease;}
  .accordion-header.active .icon{transform:rotate(180deg);}
  input[type=checkbox]:checked+label{text-decoration:line-through;color:#a0aec0;}
  .confirmation-table th,.confirmation-table td{text-align:center;padding:.75rem .5rem;border:1px solid #e2e8f0;font-size:.875rem}
  .confirmation-table th{background:#f8fafc;font-weight:600}
  .confirmation-table .member-name{text-align:left;font-weight:600;white-space:nowrap}
  .info-section{padding:1rem;background:#f8fafc;border-radius:8px;margin-bottom:1rem}
  .info-title{font-weight:600;color:#1e3a8a;margin-bottom:.5rem}
  .highlight-box{background:#fffbeb;border-left:4px solid #f59e0b;padding:1rem;margin-top:1rem;border-radius:4px}
  .comparison-table th,.comparison-table td{border:1px solid #e2e8f0;padding:.75rem;text-align:center;font-size:.875rem}
  .comparison-table th{background:#f1f5f9;font-weight:600}
  .hidden-important{display:none !important;} /* Day-0 mode */
</style>
</head>
<body class="bg-gray-50 text-gray-800">

<!-- ===== Firebase 전역 구성값 (필수) ===== -->
<script>
  const __firebase_config = JSON.stringify({
    apiKey: "AIzaSyA27iXhZPvc0w6lzaw9mGpbe2pbIWliQtc",
    authDomain: "freene-nanjing-2025.firebaseapp.com",
    projectId: "freene-nanjing-2025",
    storageBucket: "freene-nanjing-2025.firebasestorage.app",
    messagingSenderId: "106888422558",
    appId: "1:106888422558:web:429a64702973b71ecf878f",
    measurementId: "G-1NJ9PW5TF8"
  });
  const __app_id = "freene-nanjing-2025";
  const __initial_auth_token = ""; // 익명 로그인 사용
</script>

<div id="app-root" class="container mx-auto max-w-4xl p-4 sm:p-8">
  <header class="text-center mb-8">
    <h1 class="text-3xl sm:text-4xl font-bold text-blue-600">프리네가족팀 남경 여행</h1>
    <p class="text-lg text-gray-600 mt-1">최종 점검 & 온라인 숙지현황</p>
    <p id="dday-widget" class="text-lg font-semibold text-red-600 mt-2"></p>
  </header>

  <!-- 온라인 숙지 현황 테이블 -->
  <div id="online-status-card" class="bg-white rounded-lg shadow-md border border-gray-200 p-5 mb-8">
    <h2 class="text-xl font-semibold text-blue-700 mb-4 text-center">
      <i class="fas fa-user-check mr-2"></i>팀원별 숙지 현황
    </h2>
    <p class="text-center text-gray-600 mb-4">
      Firestore 실시간 동기화. (준비물 개별항목은 공유되지 않음)
    </p>
    <div id="confirmation-container" class="overflow-x-auto">
      <p class="text-center text-gray-500">불러오는 중…</p>
    </div>
  </div>

  <!-- 이름 선택 화면 -->
  <div id="login-screen" class="mb-8">
    <div class="bg-white rounded-lg shadow-md border border-gray-200 p-5 text-center">
      <h2 class="text-xl sm:text-2xl font-semibold mb-4">본인의 이름을 선택하세요.</h2>
      <div id="name-selector" class="grid grid-cols-2 sm:grid-cols-3 gap-4"></div>
    </div>
  </div>

  <!-- 메인 화면 (이름 선택 후 표시) -->
  <div id="main-screen" class="space-y-4 hidden">
    <header class="flex flex-col sm:flex-row items-center justify-between gap-4 mb-4">
      <div class="text-center sm:text-left">
        <h2 class="text-2xl font-bold text-blue-600"><span id="user-name"></span>님 환영합니다!</h2>
        <p class="text-md text-gray-600 mt-1">아래 항목들을 읽고 확인 후 체크하세요.</p>
      </div>
      <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
        <button id="logout-button" class="w-full sm:w-auto bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg transition">
          <i class="fas fa-arrow-left mr-2"></i>이름 다시 선택
        </button>
        <button id="reset-data-button" class="w-full sm:w-auto bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition">
          데이터 초기화
        </button>
      </div>
    </header>

    <!-- 온라인 공유 토글 -->
    <div class="bg-white rounded-lg shadow-md border border-gray-200 p-4 flex items-center justify-between">
      <label for="online-share-toggle" class="text-sm sm:text-base font-medium text-gray-700 flex-1 text-left">
        이 기기의 체크 결과를 온라인 표에 공유.
      </label>
      <input id="online-share-toggle" type="checkbox" class="h-5 w-5 text-blue-600 rounded border-gray-300 cursor-pointer">
    </div>

    <!-- 섹션 컨테이너 -->
    <div class="space-y-4" id="main-content-sections"><!-- JS inject --></div>
  </div>
</div>

<!-- ===== Firebase + App Logic ===== -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, doc, onSnapshot, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  /* ------------------ 기본 구성 ------------------ */
  const APP_VERSION = "v4-online";
  const STORAGE_KEY = `tripPrepData-Nanjing2025-${APP_VERSION}`;

  const teamMembers = ["강문순","김준형","김현정","안상현","김현주","박영순"];
  const sections = { plan:"집결계획", info:"주요안내", checklist:"준비물", schedule:"일정표" };

  const checklistItems = {
    docs: [
      {id:'c1',text:'여권 (사본 별도 보관)'},
      {id:'c2',text:'항공권 E-ticket'},
      {id:'c3',text:'해외사용 가능 신용카드'},
      {id:'c4',text:'위안화 현금 (소액권)'}
    ],
    clothing: [
      {id:'c5',text:'여름옷, 편한 신발, 속옷'},
      {id:'c6',text:'냉방 대비용 겉옷'},
      {id:'c7',text:'모자, 선글라스, 자외선 차단제'},
      {id:'c8',text:'접는 우산/양산 (선택)'}
    ],
    electronics: [
      {id:'c9',text:'스마트폰, 보조배터리'},
      {id:'c10',text:'중국용 전원 어댑터'},
      {id:'c11',text:'충전 케이블, 멀티탭 (선택)'}
    ],
    medicine: [
      {id:'c12',text:'개인 복용약 (필수)'},
      {id:'c13',text:'종합감기약, 소화제, 밴드 등'},
      {id:'c14',text:'비상 간식 (선택)'}
    ]
  };
  const TOTAL_CHECK_ITEMS = Object.values(checklistItems).flat().length; // 14
  const SHARE_CHECK_COUNTS = true; // 온라인 표에 준비물 개수 표시

  /* ------------------ 전역 상태 ------------------ */
  let currentUser = null;
  let confirmationData = {}; // 로컬
  let shareEnabled = false;  // 내 기기 온라인 공유 토글
  let onlineData = {};       // Firestore 실시간 데이터

  /* ------------------ DOM refs ------------------ */
  const loginScreen = document.getElementById('login-screen');
  const nameSelector = document.getElementById('name-selector');
  const mainScreen  = document.getElementById('main-screen');
  const userNameSpan = document.getElementById('user-name');
  const mainContentContainer = document.getElementById('main-content-sections');
  const confirmationContainer = document.getElementById('confirmation-container');
  const logoutButton = document.getElementById('logout-button');
  const resetButton = document.getElementById('reset-data-button');
  const onlineShareToggle = document.getElementById('online-share-toggle');

  /* ------------------ 로컬 스토리지 ------------------ */
  function initLocalData(){
    confirmationData = {};
    teamMembers.forEach(m=>{
      confirmationData[m]={};
      Object.keys(sections).forEach(k=>confirmationData[m][k]=false);
      confirmationData[m].checklist={};
        confirmationData[m].checklist_all = false; // 
      for(const cat in checklistItems){
        checklistItems[cat].forEach(it=>{
          confirmationData[m].checklist[it.id]=false;
        });
      }
    });
    saveLocalData();
  }
  function loadLocalData(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw){ initLocalData(); return; }
      confirmationData = JSON.parse(raw);
    }catch(e){
      console.error('local parse fail',e);
      initLocalData();
    }
  }
  function saveLocalData(){
    try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(confirmationData)); }
    catch(e){ console.error('local save fail',e); }
  }
  function resetLocal(){
    if(!confirm('모든 로컬 체크 상태를 초기화할까요?')) return;
    localStorage.removeItem(STORAGE_KEY);
    initLocalData();
    if(currentUser) renderMainContent(currentUser);
  }

  /* ------------------ Firebase 초기화 ------------------ */
  const firebaseConfig = (()=>{
    try { return JSON.parse(__firebase_config); }
    catch(e){ return {apiKey:'DEMO',authDomain:'DEMO',projectId:'DEMO'}; }
  })();
  const appId = (typeof __app_id!=='undefined' && __app_id) ? __app_id : 'trip-prep-default';

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // 단일 문서 경로 (문서로 끝나야 함!)
  // artifacts/{appId}/public/trip_confirmations_status
const docRef = doc(db, "artifacts", appId, "public", "status");

  async function firebaseInitAuth(){
    try{
      if(typeof __initial_auth_token!=='undefined' && __initial_auth_token){
        await signInWithCustomToken(auth, __initial_auth_token);
      }else{
        await signInAnonymously(auth);
      }
    }catch(e){
      console.error('Firebase auth error',e);
    }
  }

  /* ------------------ Firestore 실시간 구독 ------------------ */
  function subscribeOnlineData(){
    onSnapshot(docRef,(snap)=>{
      if(snap.exists()){
        onlineData = snap.data();
      }else{
        // 문서 없으면 초기 생성
        const base={};
        teamMembers.forEach(m=>{
          base[m]={};
          Object.keys(sections).forEach(k=>base[m][k]=false);
          if(SHARE_CHECK_COUNTS){ base[m].checkCount=0; base[m].checkTotal=TOTAL_CHECK_ITEMS; }
        });
        setDoc(docRef,base).catch(e=>console.error('init doc fail',e));
        onlineData = base;
      }
      renderOnlineTable(onlineData);
    },(err)=>{
      console.error('snapshot error',err);
      confirmationContainer.innerHTML = '<p class="text-red-500 text-center">온라인 데이터를 불러오지 못했습니다.</p>';
    });
  }

  /* ------------------ Firestore 업데이트 ------------------ */
  async function pushAllOnline(member){
    if(!shareEnabled) return;
    const counts = countChecklist(member);
    const allCl = allChecklistDone(member);
    const payload = {
      [`${member}.plan`]: !!confirmationData[member].plan,
      [`${member}.info`]: !!confirmationData[member].info,
      [`${member}.checklist`]: allCl,   // 준비물 전부 확인했는지
      [`${member}.schedule`]: !!confirmationData[member].schedule,
    };
    if(SHARE_CHECK_COUNTS){
      payload[`${member}.checkCount`] = counts.checked;
      payload[`${member}.checkTotal`] = counts.total;
    }
    payload["_meta"] = {updated:Date.now()};
    try{ await updateDoc(docRef,payload); }
    catch(e){ await setDoc(docRef,payload,{merge:true}); }
  }

  async function updateOnline(member,section,value){
    if(!shareEnabled) return;
    const payload={};
    payload[`${member}.${section}`]=value;
    if(section==='checklist' && SHARE_CHECK_COUNTS){
      const counts=countChecklist(member);
      payload[`${member}.checkCount`]=counts.checked;
      payload[`${member}.checkTotal`]=counts.total;
    }
    payload["_meta"]={updated:Date.now()};
    try{ await updateDoc(docRef,payload); }
    catch(e){ await setDoc(docRef,payload,{merge:true}); }
  }

  /* ------------------ 준비물 개수 집계 ------------------ */
  function countChecklist(member){
    const cl = confirmationData[member]?.checklist || {};
    let c=0;
    for(const cat in checklistItems){
      checklistItems[cat].forEach(it=>{
        if(cl[it.id]) c++;
      });
    }
    return {checked:c,total:TOTAL_CHECK_ITEMS};
  }
  function allChecklistDone(member){
    const cl = confirmationData[member]?.checklist || {};
    for(const cat in checklistItems){
      for(const it of checklistItems[cat]){
        if(!cl[it.id]) return false;
      }
    }
    return true;
  }
  function setAllChecklist(member,val){
    for(const cat in checklistItems){
      for(const it of checklistItems[cat]){
        confirmationData[member].checklist[it.id]=val;
        const cb=document.getElementById(it.id);
        if(cb) cb.checked=val;
      }
    }
  }

  /* ------------------ 온라인 표 렌더 ------------------ */
  function renderOnlineTable(data){
    if(!confirmationContainer) return;
    const secKeys = Object.keys(sections);
    const secNames = Object.values(sections);
    let html='<table class="w-full confirmation-table"><thead><tr><th class="member-name">팀원</th>';
    secNames.forEach(n=>{ html += `<th>${n}</th>`; });
    if(SHARE_CHECK_COUNTS) html+='<th>준비물(개수)</th>';
    html+='</tr></thead><tbody>';
    teamMembers.forEach(m=>{
      const row=data[m]||{};
      html+=`<tr><td class="member-name">${m}</td>`;
      secKeys.forEach(k=>{
        html+=`<td>${row[k]?'✔️':''}</td>`;
      });
      if(SHARE_CHECK_COUNTS){
        const cc = typeof row.checkCount==='number'?row.checkCount:0;
        const tt = typeof row.checkTotal==='number'?row.checkTotal:TOTAL_CHECK_ITEMS;
        html+=`<td>${cc}/${tt}</td>`;
      }
      html+='</tr>';
    });
    html+='</tbody></table>';
    confirmationContainer.innerHTML=html;
  }

  /* ------------------ 로그인 화면 렌더 ------------------ */
  function renderLoginScreen(){
    nameSelector.innerHTML='';
    teamMembers.forEach(name=>{
      const btn=document.createElement('button');
      btn.type='button';
      btn.className='p-4 bg-blue-500 text-white font-bold rounded-lg hover:bg-blue-600 transition transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500';
      btn.textContent=name;
      btn.dataset.name=name;
      nameSelector.appendChild(btn);
    });
  }

  /* ------------------ 메인 화면 렌더 ------------------ */
  function renderMainContent(user){
    userNameSpan.textContent=user;
    mainContentContainer.innerHTML=`
      <div id="section-plan" class="accordion-item bg-white rounded-lg shadow-md border border-gray-200"></div>
      <div id="section-info" class="accordion-item bg-white rounded-lg shadow-md border border-gray-200"></div>
      <div id="section-checklist" class="accordion-item bg-white rounded-lg shadow-md border border-gray-200"></div>
      <div id="section-schedule" class="accordion-item bg-white rounded-lg shadow-md border border-gray-200"></div>
    `;
    populateContent();
    applyUserState(user);
    setupAccordion();
    applyDay0Mode();
  }

  /* ------------------ 섹션 내용 HTML 주입 ------------------ */
  function populateContent(){
    // Plan
    document.getElementById('section-plan').innerHTML=`
      <div class="accordion-header flex justify-between items-center p-5">
        <h2 class="text-xl font-semibold text-blue-700"><i class="fas fa-plane-departure mr-3"></i>첫날 집결 및 출국 계획 (가장 중요!)</h2>
        <div class="flex items-center space-x-2">
          <label for="check-plan" class="text-sm font-medium text-gray-600">확인완료</label>
          <input type="checkbox" id="check-plan" data-section="plan" class="h-5 w-5 rounded border-gray-300 text-blue-600">
        </div>
        <i class="fas fa-chevron-down icon ml-4"></i>
      </div>
      <div class="accordion-content p-5 border-t border-gray-200">
        <div class="overflow-x-auto">
          <table class="w-full text-left border-collapse">
            <thead class="bg-blue-50">
              <tr>
                <th class="p-3 font-semibold text-sm">시간</th>
                <th class="p-3 font-semibold text-sm">계획</th>
                <th class="p-3 font-semibold text-sm">장소</th>
                <th class="p-3 font-semibold text-sm">담당 및 비고</th>
              </tr>
            </thead>
            <tbody>
              <tr class="border-b"><td class="p-3">09:20</td><td class="p-3">전원 집결 및 인원 점검</td><td class="p-3">인천공항 제1여객터미널 3층 F열 아시아나항공 카운터 앞</td><td class="p-3">김현정 (리더)</td></tr>
              <tr class="border-b"><td class="p-3">09:30</td><td class="p-3">단체 수속 및 수하물 위탁</td><td class="p-3">아시아나항공 카운터</td><td class="p-3">전원 (여권 필수 지참)</td></tr>
              <tr class="border-b"><td class="p-3">10:30</td><td class="p-3">보안 검색 및 출국 심사</td><td class="p-3">3층 출국장</td><td class="p-3">개별 진행</td></tr>
              <tr class="border-b"><td class="p-3">11:00</td><td class="p-3">면세구역 내 자유시간 및 아침/점심</td><td class="p-3">면세구역</td><td class="p-3">개별 또는 그룹 활동</td></tr>
              <tr class="border-b"><td class="p-3">11:50</td><td class="p-3">탑승구 앞 집결</td><td class="p-3">탑승구 (E-ticket 확인)</td><td class="p-3 text-red-500 font-bold">시간 엄수</td></tr>
              <tr><td class="p-3">12:20</td><td class="p-3">남경으로 출발 (OZ349)</td><td class="p-3">-</td><td class="p-3">-</td></tr>
            </tbody>
          </table>
        </div>
      </div>`;

    // Info
document.getElementById('section-info').innerHTML = `
    <div class="accordion-header flex justify-between items-center p-5">
        <h2 class="text-xl font-semibold text-blue-700"><i class="fas fa-info-circle mr-3"></i>여행 중 주요 안내사항</h2>
        <div class="flex items-center space-x-2">
            <label for="check-info" class="text-sm font-medium text-gray-600">확인완료</label>
            <input type="checkbox" id="check-info" data-section="info" class="h-5 w-5 rounded border-gray-300 text-blue-600">
        </div>
        <i class="fas fa-chevron-down icon ml-4"></i>
    </div>
    <div class="accordion-content p-5 border-t border-gray-200 space-y-4">
        <div class="info-section">
            <h4 class="info-title"><i class="fas fa-users-cog mr-2"></i>주요 담당자 안내</h4>
            <ul class="list-disc list-inside ml-4 space-y-2 text-gray-700">
                <li><strong>총괄 리더: 김현정</strong> – 전체 일정, 가이드 소통, 공동경비.</li>
                <li><strong>통신/기술 지원: 안상현</strong> – 로밍/유심, 결제 앱, 스마트폰 문제 도움.</li>
                <li><strong>건강 담당: 김현주</strong> – 공용 구급약, 건강 관련 지원.</li>
            </ul>
        </div>
        <div class="info-section">
            <h4 class="info-title"><i class="fas fa-walking mr-2"></i>건강 및 체력 관리</h4>
            <p>2일차, 3일차는 도보 이동이 많고 7월 말 남경 날씨는 매우 더울 것으로 예상되니, 편한 신발과 가벼운 옷차림은 필수입니다. 어르신들의 컨디션을 고려하여 가이드에게 동선 조정을 요청했으며, 하루 1~2회 카페 휴식 시간을 가질 예정입니다.</p>
        </div>
        <div class="info-section">
            <h4 class="info-title"><i class="fas fa-utensils mr-2"></i>식사 및 비상 식량</h4>
            <p>여행 중 1회 한식당을 이용할 예정입니다. 그 외 현지 음식이 입맛에 맞지 않을 경우를 대비하여, 비상 식량(김, 김치, 컵라면, 햇반 등)을 준비했습니다. (담당: 김현정)</p>
        </div>
        <div class="info-section">
            <h4 class="info-title"><i class="fas fa-wifi mr-2"></i>인터넷 사용: 로밍 vs 현지 유심</h4>
            <p class="mb-4 text-sm">중국 현지에서 인터넷 사용 시, **국제 로밍**과 **현지 유심(eSIM)** 중 개인의 필요에 맞게 자유롭게 선택할 수 있습니다. 아래의 장단점을 고려하여 선택해주세요.</p>
            <table class="w-full border-collapse text-left">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="w-1/6 border p-3 font-semibold">구분</th>
                        <th class="w-5/12 border p-3 font-semibold">현지 유심 / eSIM</th>
                        <th class="w-5/12 border p-3 font-semibold">국제 로밍 (한국 유심)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="align-top">
                        <td class="border bg-green-50 p-4 font-bold text-green-800">장점 👍</td>
                        <td class="border p-4"><ul class="list-disc list-inside space-y-2 text-sm"><li>데이터 요금이 매우 저렴하고 네트워크가 안정적</li><li>바이두, 위챗 등 현지 앱 사용에 용이</li></ul></td>
                        <td class="border p-4"><ul class="list-disc list-inside space-y-2 text-sm"><li>VPN 없이 Gmail, 카카오톡, 인스타 등 즉시 사용 가능</li><li>한국 번호를 그대로 사용해 인증 및 연락이 편리</li><li>설정이 간편하고 별도의 우회 작업이 불필요</li></ul></td>
                    </tr>
                    <tr class="align-top">
                        <td class="border bg-red-50 p-4 font-bold text-red-800">단점 👎</td>
                        <td class="border p-4"><ul class="list-disc list-inside space-y-2 text-sm"><li>Gmail, 카카오톡 등 대부분의 한국/해외 서비스는 <strong>유료 VPN을 설치해야만 사용 가능</strong></li><li>최근 VPN 단속으로 일부 서비스가 불안정할 수 있음</li><li>무료 VPN은 보안 위험이 크고 접속 및 속도 보장이 어려움</li></ul></td>
                        <td class="border p-4"><ul class="list-disc list-inside space-y-2 text-sm"><li>요금이 비쌈 (일 1~2만원대 또는 제한적인 무제한 옵션)</li><li>데이터 사용량이나 속도에 제한이 있을 수 있음</li></ul></td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="info-section">
            <h4 class="info-title"><i class="fas fa-money-bill-wave mr-2"></i>개인 경비 및 중국 현지 결제 방법</h4>
            <p class="mb-2">여행경비 대부분은 이미 지불되었습니다. 현지에서 필요한 개인 경비는 <strong>개인 쇼핑, 간식, 선택적 가이드/기사님 팁</strong> 정도입니다.</p>
            <p class="mb-4">중국은 QR 결제가 편리합니다. 네이버페이(충전) + 알리페이(신용카드 연동) 조합을 추천합니다.</p>
            <div class="p-4 border rounded-md mb-3">
                <h5 class="font-semibold text-lg text-green-600">방법 1. 네이버페이 (현금 충전)</h5>
                <p class="text-sm text-gray-600 mt-1">가게 QR 촬영 후 바로 결제. 미리 머니 충전.</p>
            </div>
            <div class="p-4 border rounded-md">
                <h5 class="font-semibold text-lg text-blue-600">방법 2. 알리페이 (해외결제 카드)</h5>
                <p class="text-sm text-gray-600 mt-1">해외사용 가능 신용카드 등록. 네이버페이 안 되는 곳에서 유용.</p>
            </div>
            <div class="highlight-box">
                <p class="font-bold text-center text-lg">어려우신가요? 걱정 마세요!</p>
                <p class="text-center mt-2 text-gray-700">준비가 어려우신 분들은 <strong>출국 당일 공항에서 담당자(안상현)가 도와드릴 예정</strong>입니다. 스마트폰과 신용카드만 잘 챙겨오세요. 단, 당일의 혼잡도를 고려하여 네이버페이 앱을 미리 설치하고 충전해두시는 것을 가장 추천드립니다.</p>
            </div>
        </div>
        <div class="info-section">
            <h4 class="info-title"><i class="fas fa-shield-alt mr-2"></i>안전 및 기타 유의사항</h4>
            <ul class="list-disc list-inside ml-4 mt-2 space-y-2 text-gray-700">
                <li><strong>소지품 관리:</strong> 사람이 많은 곳에서 소매치기 주의. 여권·현금 안전 보관.</li>
                <li><strong>비상시 대처:</strong> 가이드/숙소 연락처 소지, 여권 사본(사진) 휴대전화 저장.</li>
                <li><strong>단체 행동:</strong> 가이드 안내에 따라 함께 이동. 돌발 단독 행동 자제.</li>
            </ul>
        </div>
    </div>`;

    // Checklist
    let clHTML=`
      <div class="accordion-header flex justify-between items-center p-5">
        <h2 class="text-xl font-semibold text-blue-700"><i class="fas fa-list-check mr-3"></i>준비물 체크리스트</h2>
        <div class="flex items-center space-x-2">
          <label for="check-checklist" class="text-sm font-medium text-gray-600">모두 확인</label>
          <input type="checkbox" id="check-checklist" data-section="checklist" class="h-5 w-5 rounded border-gray-300 text-blue-600">
        </div>
        <i class="fas fa-chevron-down icon ml-4"></i>
      </div>
      <div class="accordion-content p-5 border-t border-gray-200 grid grid-cols-1 md:grid-cols-2 gap-6">`;
    const cats={docs:'서류/금융',clothing:'의류/생활',electronics:'전자기기',medicine:'상비약/기타'};
    for(const cat in checklistItems){
      clHTML+=`<div><h4 class="font-bold mb-2">${cats[cat]}</h4><ul class="space-y-2">`;
      checklistItems[cat].forEach(it=>{
        clHTML+=`<li><input type="checkbox" id="${it.id}" data-section="checklist" data-item="${it.id}" class="h-4 w-4 rounded border-gray-300 text-blue-600"><label for="${it.id}" class="ml-2">${it.text}</label></li>`;
      });
      clHTML+='</ul></div>';
    }
    clHTML+='</div>';
    document.getElementById('section-checklist').innerHTML=clHTML;

 // Schedule
document.getElementById('section-schedule').innerHTML = `
    <div class="accordion-header flex justify-between items-center p-5">
        <h2 class="text-xl font-semibold text-blue-700"><i class="fas fa-calendar-alt mr-3"></i>3박 4일 세부 일정표</h2>
        <div class="flex items-center space-x-2">
            <label for="check-schedule" class="text-sm font-medium text-gray-600">확인완료</label>
            <input type="checkbox" id="check-schedule" data-section="schedule" class="h-5 w-5 rounded border-gray-300 text-blue-600">
        </div>
        <i class="fas fa-chevron-down icon ml-4"></i>
    </div>
    <div class="accordion-content p-5 border-t border-gray-200">
        <div class="space-y-6">

            <div class="p-5 border rounded-lg bg-white shadow-sm">
                <h3 class="text-lg font-bold text-blue-700 mb-4">1일차 (7/26, 토): 남경 도착 및 옛거리 탐방</h3>
                <div class="relative pl-20">
                    <div class="absolute left-3 top-1 bottom-1 w-0.5 bg-gray-200"></div>

                    <div class="relative mb-5">
                        <div class="absolute left-[-2.1rem] top-1 w-10 h-10 bg-red-500 text-white rounded-full flex items-center justify-center ring-4 ring-white">
                            <i class="fas fa-users"></i>
                        </div>
                        <p class="font-semibold text-gray-800">09:20 - 인천공항 집결</p>
                        <p class="text-sm text-gray-600">제1여객터미널 3층 F열, 단체 수속</p>
                        <span class="text-xs font-semibold text-red-600 bg-red-100 px-2 py-1 rounded-full">시간 엄수!</span>
                    </div>
                    <div class="relative mb-5">
                        <div class="absolute left-[-2.1rem] top-1 w-10 h-10 bg-blue-500 text-white rounded-full flex items-center justify-center ring-4 ring-white">
                            <i class="fas fa-plane-departure"></i>
                        </div>
                        <p class="font-semibold text-gray-800">12:20 - 남경으로 출발 (OZ349)</p>
                        <p class="text-sm text-gray-600">공항에서 점심 식사 권장 (비행시간 약 2시간)</p>
                    </div>
                    <div class="relative mb-5">
                        <div class="absolute left-[-2.1rem] top-1 w-10 h-10 bg-green-500 text-white rounded-full flex items-center justify-center ring-4 ring-white">
                            <i class="fas fa-camera-retro"></i>
                        </div>
                        <p class="font-semibold text-gray-800">오후 - 교부영, 부자묘 옛거리 관광</p>
                        <p class="text-sm text-gray-600">남경의 역사와 문화를 느낄 수 있는 대표 명소 방문</p>
                    </div>
                    <div class="relative mb-5">
                        <div class="absolute left-[-2.1rem] top-1 w-10 h-10 bg-yellow-500 text-white rounded-full flex items-center justify-center ring-4 ring-white">
                            <i class="fas fa-utensils"></i>
                        </div>
                        <p class="font-semibold text-gray-800">저녁 식사 (현지식)</p>
                    </div>
                    <div class="relative">
                        <div class="absolute left-[-2.1rem] top-1 w-10 h-10 bg-purple-500 text-white rounded-full flex items-center justify-center ring-4 ring-white">
                            <i class="fas fa-bed"></i>
                        </div>
                        <p class="font-semibold text-gray-800">호텔 체크인 및 휴식</p>
                    </div>
                </div>
            </div>

            <div class="p-5 border rounded-lg bg-white shadow-sm">
                <h3 class="text-lg font-bold text-blue-700 mb-4">2일차 (7/27, 일): 아픈 역사와 마주하기</h3>
                <div class="relative pl-14">
                    <div class="absolute left-3 top-1 bottom-1 w-0.5 bg-gray-200"></div>
                    <div class="relative mb-5">
                        <div class="absolute left-[-2.1rem] top-1 w-10 h-10 bg-slate-600 text-white rounded-full flex items-center justify-center ring-4 ring-white">
                            <i class="fas fa-monument"></i>
                        </div>
                        <p class="font-semibold text-gray-800">오전 - 남경대학살기념관, 위안부 박물관</p>
                        <p class="text-sm text-gray-600">잊지 말아야 할 역사의 현장 방문</p>
                    </div>
                    <div class="relative mb-5">
                        <div class="absolute left-[-2.1rem] top-1 w-10 h-10 bg-teal-500 text-white rounded-full flex items-center justify-center ring-4 ring-white">
                            <i class="fas fa-landmark"></i>
                        </div>
                        <p class="font-semibold text-gray-800">오후 - 중산릉, 명효릉 관광</p>
                        <p class="text-sm text-gray-600">중국의 근대사와 명나라 시대의 웅장함 체험</p>
                    </div>
                    <div class="relative mb-5">
                        <div class="absolute left-[-2.1rem] top-1 w-10 h-10 bg-cyan-500 text-white rounded-full flex items-center justify-center ring-4 ring-white">
                            <i class="fas fa-spa"></i>
                        </div>
                        <p class="font-semibold text-gray-800">저녁 - 전신 마사지 체험</p>
                        <p class="text-sm text-gray-600">하루의 피로를 푸는 시간</p>
                    </div>
                    <div class="relative">
                        <div class="absolute left-[-2.1rem] top-1 w-10 h-10 bg-yellow-500 text-white rounded-full flex items-center justify-center ring-4 ring-white">
                            <i class="fas fa-utensils"></i>
                        </div>
                        <p class="font-semibold text-gray-800">저녁 식사 (현지식)</p>
                    </div>
                </div>
            </div>

            <div class="p-5 border rounded-lg bg-white shadow-sm">
                <h3 class="text-lg font-bold text-blue-700 mb-4">3일차 (7/28, 월): 자연과 도심 속 힐링</h3>
                <div class="relative pl-14">
                    <div class="absolute left-3 top-1 bottom-1 w-0.5 bg-gray-200"></div>
                    <div class="relative mb-5">
                        <div class="absolute left-[-2.1rem] top-1 w-10 h-10 bg-green-600 text-white rounded-full flex items-center justify-center ring-4 ring-white">
                            <i class="fas fa-mountain"></i>
                        </div>
                        <p class="font-semibold text-gray-800">오전 - 우수산 관광</p>
                        <p class="text-sm text-gray-600">아름다운 자연 경관과 불교 문화 탐방</p>
                    </div>
                    <div class="relative mb-5">
                        <div class="absolute left-[-2.1rem] top-1 w-10 h-10 bg-sky-500 text-white rounded-full flex items-center justify-center ring-4 ring-white">
                            <i class="fas fa-flag"></i>
                        </div>
                        <p class="font-semibold text-gray-800">오후 - 더지플라자, 독립군 본부 터</p>
                        <p class="text-sm text-gray-600">남경의 현대적인 모습과 대한민국 임시정부의 발자취</p>
                    </div>
                    <div class="relative mb-5">
                        <div class="absolute left-[-2.1rem] top-1 w-10 h-10 bg-indigo-500 text-white rounded-full flex items-center justify-center ring-4 ring-white">
                            <i class="fas fa-ship"></i>
                        </div>
                        <p class="font-semibold text-gray-800">저녁 - 현무공원(뱃놀이)</p>
                        <p class="text-sm text-gray-600">호수 위에서 즐기는 남경의 야경</p>
                    </div>
                    <div class="relative">
                        <div class="absolute left-[-2.1rem] top-1 w-10 h-10 bg-yellow-500 text-white rounded-full flex items-center justify-center ring-4 ring-white">
                            <i class="fas fa-utensils"></i>
                        </div>
                        <p class="font-semibold text-gray-800">저녁 식사 (현지식)</p>
                    </div>
                </div>
            </div>

            <div class="p-5 border rounded-lg bg-white shadow-sm">
                <h3 class="text-lg font-bold text-blue-700 mb-4">4일차 (7/29, 화): 마지막 여정 그리고 복귀</h3>
                <div class="relative pl-14">
                    <div class="absolute left-3 top-1 bottom-1 w-0.5 bg-gray-200"></div>
                    <div class="relative mb-5">
                        <div class="absolute left-[-2.1rem] top-1 w-10 h-10 bg-orange-500 text-white rounded-full flex items-center justify-center ring-4 ring-white">
                            <i class="fas fa-archway"></i>
                        </div>
                        <p class="font-semibold text-gray-800">오전 - 남경 중화문 관광</p>
                        <p class="text-sm text-gray-600">견고한 성벽을 거닐며 여행 마무리</p>
                    </div>
                    <div class="relative mb-5">
                        <div class="absolute left-[-2.1rem] top-1 w-10 h-10 bg-blue-500 text-white rounded-full flex items-center justify-center ring-4 ring-white">
                            <i class="fas fa-plane-departure"></i>
                        </div>
                        <p class="font-semibold text-gray-800">오후 - 남경 공항으로 이동 및 출국</p>
                    </div>
                    <div class="relative">
                        <div class="absolute left-[-2.1rem] top-1 w-10 h-10 bg-gray-700 text-white rounded-full flex items-center justify-center ring-4 ring-white">
                            <i class="fas fa-house-chimney"></i>
                        </div>
                        <p class="font-semibold text-gray-800">저녁 - 인천 도착</p>
                        <p class="text-sm text-gray-600">모든 일정 종료, 해산</p>
                    </div>
                </div>
            </div>

        </div>
    </div>`;
  }
/* ------------------ 사용자 상태 적용 ------------------ */
function applyUserState(user) {
    const ud = confirmationData[user] || {};
    Object.keys(sections).forEach(k => {
        const el = document.getElementById(`check-${k}`);
        if (el) {
            // '준비물' 섹션은 checklist_all 값을 사용하고, 나머지는 원래대로 사용
            if (k === 'checklist') {
                el.checked = !!ud.checklist_all; // userData가 아니라 ud를 사용
            } else {
                el.checked = !!ud[k]; // userData가 아니라 ud를 사용
            }
        }
    });
    // 개별 준비물
    document.querySelectorAll('#section-checklist input[type=checkbox][data-item]').forEach(cb => cb.checked = false);
    if (ud.checklist) {
        for (const cat in checklistItems) {
            checklistItems[cat].forEach(it => {
                const cb = document.getElementById(it.id);
                if (cb) cb.checked = !!ud.checklist[it.id];
            });
        }
    }
}

  /* ------------------ 이벤트 묶기 ------------------ */
  function setupGlobalEvents(){
    // 이름 선택
    nameSelector.addEventListener('click',e=>{
      if(e.target.tagName!=='BUTTON') return;
      currentUser=e.target.dataset.name;
      loginScreen.classList.add('hidden');
      mainScreen.classList.remove('hidden');
      renderMainContent(currentUser);
    });

    // 로그아웃
    logoutButton.addEventListener('click',()=>{
      currentUser=null;
      mainScreen.classList.add('hidden');
      loginScreen.classList.remove('hidden');
    });

    // 로컬 초기화
    resetButton.addEventListener('click',resetLocal);

    // 온라인 공유 토글
    onlineShareToggle.addEventListener('change',()=>{
      shareEnabled=onlineShareToggle.checked;
      if(shareEnabled && currentUser){
        pushAllOnline(currentUser);
      }
    });

    // 메인 컨텐츠 체크 델리게이션
    mainContentContainer.addEventListener('change',e=>{
      if(e.target.tagName!=='INPUT' || e.target.type!=='checkbox') return;
      if(!currentUser) return;
      const section=e.target.dataset.section;
      const itemId=e.target.dataset.item||null;
      const checked=e.target.checked;
      updateLocalState(currentUser,section,checked,itemId);
      if(section && !itemId){
        updateOnline(currentUser,section,checked);
      }else if(itemId){
        if(shareEnabled) pushAllOnline(currentUser); // 수량 반영
      }
    });
  }

/* ------------------ 로컬 상태 갱신 ------------------ */
function updateLocalState(user, section, checked, itemId = null) {
    if (!confirmationData[user]) confirmationData[user] = { checklist: {} };
    if (itemId) { // 개별 준비물 항목
        confirmationData[user].checklist[itemId] = checked;
        const allDone = allChecklistDone(user);
        confirmationData[user].checklist_all = allDone; // '모두 확인' 상태 업데이트
        const secBox = document.getElementById('check-checklist');
        if (secBox) secBox.checked = allDone;
    } else { // 섹션 전체
        if (section === 'checklist') {
            confirmationData[user].checklist_all = checked; // '모두 확인' 상태만 변경
            setAllChecklist(user, checked); // 개별 항목들 상태도 변경
        } else {
            confirmationData[user][section] = checked;
        }
    }
    saveLocalData();
}

  /* ------------------ 아코디언 ------------------ */
  function setupAccordion(){
    const items=document.querySelectorAll('.accordion-item');
    items.forEach(it=>{
      const header=it.querySelector('.accordion-header');
      const content=it.querySelector('.accordion-content');
      if(!header||!content) return;
      header.addEventListener('click',e=>{
        if(e.target.tagName==='INPUT'||e.target.tagName==='LABEL') return;
        const active=header.classList.toggle('active');
        content.style.display=active?'block':'none';
      });
    });
    // 첫 섹션 오픈
    const firstHeader=items[0]?.querySelector('.accordion-header');
    const firstContent=items[0]?.querySelector('.accordion-content');
    if(firstHeader && firstContent){
      firstHeader.classList.add('active');
      firstContent.style.display='block';
    }
  }

  /* ------------------ D-Day 위젯 ------------------ */
  function renderDDay(){
    const target=new Date('2025-07-26T00:00:00+09:00');
    const today=new Date();
    const d=Math.ceil((target.setHours(0,0,0,0)-today.setHours(0,0,0,0))/86400000);
    const el=document.getElementById('dday-widget');
    if(!el) return;
    if(d>0) el.textContent=`D-${d} (출국까지 ${d}일)`;
    else if(d===0) el.textContent='오늘 출국! (D-Day)';
    else el.textContent=`D+${Math.abs(d)}`;
  }

  /* ------------------ Day-0 모드 ------------------ */
  function applyDay0Mode(){
    const urlFlag=new URL(location.href).searchParams.get('mode')==='day0';
    const today=new Date();
    const isDay0=(today.getFullYear()===2025 && today.getMonth()===6 && today.getDate()===26);
    if(!urlFlag && !isDay0) return;
    ['section-info','section-checklist','section-schedule'].forEach(id=>{
      document.getElementById(id)?.classList.add('hidden-important');
    });
    const root=document.getElementById('app-root');
    const banner=document.createElement('div');
    banner.className='mb-4 p-3 rounded-md bg-blue-600 text-white text-center';
    banner.textContent='출국 당일 모드: 가장 중요한 집결 정보만 표시 중';
    root.insertBefore(banner,root.firstChild);
  }

  /* ------------------ main ------------------ */
  async function main(){
    loadLocalData();
    renderLoginScreen();
    setupGlobalEvents();
    renderDDay();
    await firebaseInitAuth();
    subscribeOnlineData();
  }

  document.addEventListener('DOMContentLoaded',main);
</script>
</body>
</html>
