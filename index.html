<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>프리네가족팀 남경 여행 - 온라인 숙지현황</title>

<!-- Tailwind CDN -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Fonts & Icons -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
  body{font-family:'Inter','Noto Sans KR',sans-serif;background:#f7fafc;}
  .accordion-header{cursor:pointer;}
  .accordion-header .icon{transition:transform .3s ease;}
  .accordion-header.active .icon{transform:rotate(180deg);}
  input[type=checkbox]:checked+label{text-decoration:line-through;color:#a0aec0;}
  .confirmation-table th,.confirmation-table td{text-align:center;padding:.75rem .5rem;border:1px solid #e2e8f0;font-size:.875rem}
  .confirmation-table th{background:#f8fafc;font-weight:600}
  .confirmation-table .member-name{text-align:left;font-weight:600;white-space:nowrap}
  .info-section{padding:1rem;background:#f8fafc;border-radius:8px;margin-bottom:1rem}
  .info-title{font-weight:600;color:#1e3a8a;margin-bottom:.5rem}
  .highlight-box{background:#fffbeb;border-left:4px solid #f59e0b;padding:1rem;margin-top:1rem;border-radius:4px}
  .comparison-table th,.comparison-table td{border:1px solid #e2e8f0;padding:.75rem;text-align:center;font-size:.875rem}
  .comparison-table th{background:#f1f5f9;font-weight:600}
  .hidden-important{display:none !important;} /* Day-0 mode */
</style>
</head>
<body class="bg-gray-50 text-gray-800">

<!-- ===== Firebase 전역 구성값 (필수) ===== -->
<script>
  const __firebase_config = JSON.stringify({
    apiKey: "AIzaSyA27iXhZPvc0w6lzaw9mGpbe2pbIWliQtc",
    authDomain: "freene-nanjing-2025.firebaseapp.com",
    projectId: "freene-nanjing-2025",
    storageBucket: "freene-nanjing-2025.firebasestorage.app",
    messagingSenderId: "106888422558",
    appId: "1:106888422558:web:429a64702973b71ecf878f",
    measurementId: "G-1NJ9PW5TF8"
  });
  const __app_id = "freene-nanjing-2025";
  const __initial_auth_token = ""; // 익명 로그인 사용
</script>

<div id="app-root" class="container mx-auto max-w-4xl p-4 sm:p-8">
  <header class="text-center mb-8">
    <h1 class="text-3xl sm:text-4xl font-bold text-blue-600">프리네가족팀 남경 여행</h1>
    <p class="text-lg text-gray-600 mt-1">최종 점검 & 온라인 숙지현황</p>
    <p id="dday-widget" class="text-lg font-semibold text-red-600 mt-2"></p>
  </header>

  <!-- 온라인 숙지 현황 테이블 -->
  <div id="online-status-card" class="bg-white rounded-lg shadow-md border border-gray-200 p-5 mb-8">
    <h2 class="text-xl font-semibold text-blue-700 mb-4 text-center">
      <i class="fas fa-user-check mr-2"></i>팀원별 숙지 현황
    </h2>
    <p class="text-center text-gray-600 mb-4">
      Firestore 실시간 동기화. (준비물 개별항목은 공유되지 않음)
    </p>
    <div id="confirmation-container" class="overflow-x-auto">
      <p class="text-center text-gray-500">불러오는 중…</p>
    </div>
  </div>

  <!-- 이름 선택 화면 -->
  <div id="login-screen" class="mb-8">
    <div class="bg-white rounded-lg shadow-md border border-gray-200 p-5 text-center">
      <h2 class="text-xl sm:text-2xl font-semibold mb-4">본인의 이름을 선택하세요.</h2>
      <div id="name-selector" class="grid grid-cols-2 sm:grid-cols-3 gap-4"></div>
    </div>
  </div>

  <!-- 메인 화면 (이름 선택 후 표시) -->
  <div id="main-screen" class="space-y-4 hidden">
    <header class="flex flex-col sm:flex-row items-center justify-between gap-4 mb-4">
      <div class="text-center sm:text-left">
        <h2 class="text-2xl font-bold text-blue-600"><span id="user-name"></span>님 환영합니다!</h2>
        <p class="text-md text-gray-600 mt-1">아래 항목들을 읽고 확인 후 체크하세요.</p>
      </div>
      <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
        <button id="logout-button" class="w-full sm:w-auto bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg transition">
          <i class="fas fa-arrow-left mr-2"></i>이름 다시 선택
        </button>
        <button id="reset-data-button" class="w-full sm:w-auto bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition">
          데이터 초기화
        </button>
      </div>
    </header>

    <!-- 온라인 공유 토글 -->
    <div class="bg-white rounded-lg shadow-md border border-gray-200 p-4 flex items-center justify-between">
      <label for="online-share-toggle" class="text-sm sm:text-base font-medium text-gray-700 flex-1 text-left">
        이 기기의 체크 결과를 온라인 표에 공유.
      </label>
      <input id="online-share-toggle" type="checkbox" class="h-5 w-5 text-blue-600 rounded border-gray-300 cursor-pointer">
    </div>

    <!-- 섹션 컨테이너 -->
    <div class="space-y-4" id="main-content-sections"><!-- JS inject --></div>
  </div>
</div>

<!-- ===== Firebase + App Logic ===== -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, doc, onSnapshot, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  /* ------------------ 기본 구성 ------------------ */
  const APP_VERSION = "v4-online";
  const STORAGE_KEY = `tripPrepData-Nanjing2025-${APP_VERSION}`;

  const teamMembers = ["강문순","김준형","김현정","안상현","김현주","박영순"];
  const sections = { plan:"집결계획", info:"주요안내", checklist:"준비물", schedule:"일정표" };

  const checklistItems = {
    docs: [
      {id:'c1',text:'여권 (사본 별도 보관)'},
      {id:'c2',text:'항공권 E-ticket'},
      {id:'c3',text:'해외사용 가능 신용카드'},
      {id:'c4',text:'위안화 현금 (소액권)'}
    ],
    clothing: [
      {id:'c5',text:'여름옷, 편한 신발, 속옷'},
      {id:'c6',text:'냉방 대비용 겉옷'},
      {id:'c7',text:'모자, 선글라스, 자외선 차단제'},
      {id:'c8',text:'접는 우산/양산 (선택)'}
    ],
    electronics: [
      {id:'c9',text:'스마트폰, 보조배터리'},
      {id:'c10',text:'중국용 전원 어댑터'},
      {id:'c11',text:'충전 케이블, 멀티탭 (선택)'}
    ],
    medicine: [
      {id:'c12',text:'개인 복용약 (필수)'},
      {id:'c13',text:'종합감기약, 소화제, 밴드 등'},
      {id:'c14',text:'비상 간식 (선택)'}
    ]
  };
  const TOTAL_CHECK_ITEMS = Object.values(checklistItems).flat().length; // 14
  const SHARE_CHECK_COUNTS = true; // 온라인 표에 준비물 개수 표시

  /* ------------------ 전역 상태 ------------------ */
  let currentUser = null;
  let confirmationData = {}; // 로컬
  let shareEnabled = false;  // 내 기기 온라인 공유 토글
  let onlineData = {};       // Firestore 실시간 데이터

  /* ------------------ DOM refs ------------------ */
  const loginScreen = document.getElementById('login-screen');
  const nameSelector = document.getElementById('name-selector');
  const mainScreen  = document.getElementById('main-screen');
  const userNameSpan = document.getElementById('user-name');
  const mainContentContainer = document.getElementById('main-content-sections');
  const confirmationContainer = document.getElementById('confirmation-container');
  const logoutButton = document.getElementById('logout-button');
  const resetButton = document.getElementById('reset-data-button');
  const onlineShareToggle = document.getElementById('online-share-toggle');

  /* ------------------ 로컬 스토리지 ------------------ */
  function initLocalData(){
    confirmationData = {};
    teamMembers.forEach(m=>{
      confirmationData[m]={};
      Object.keys(sections).forEach(k=>confirmationData[m][k]=false);
      confirmationData[m].checklist={};
      for(const cat in checklistItems){
        checklistItems[cat].forEach(it=>{
          confirmationData[m].checklist[it.id]=false;
        });
      }
    });
    saveLocalData();
  }
  function loadLocalData(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw){ initLocalData(); return; }
      confirmationData = JSON.parse(raw);
    }catch(e){
      console.error('local parse fail',e);
      initLocalData();
    }
  }
  function saveLocalData(){
    try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(confirmationData)); }
    catch(e){ console.error('local save fail',e); }
  }
  function resetLocal(){
    if(!confirm('모든 로컬 체크 상태를 초기화할까요?')) return;
    localStorage.removeItem(STORAGE_KEY);
    initLocalData();
    if(currentUser) renderMainContent(currentUser);
  }

  /* ------------------ Firebase 초기화 ------------------ */
  const firebaseConfig = (()=>{
    try { return JSON.parse(__firebase_config); }
    catch(e){ return {apiKey:'DEMO',authDomain:'DEMO',projectId:'DEMO'}; }
  })();
  const appId = (typeof __app_id!=='undefined' && __app_id) ? __app_id : 'trip-prep-default';

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // 단일 문서 경로 (문서로 끝나야 함!)
  // artifacts/{appId}/public/trip_confirmations_status
const docRef = doc(db, "artifacts", appId, "trip_confirmations", "status");

  async function firebaseInitAuth(){
    try{
      if(typeof __initial_auth_token!=='undefined' && __initial_auth_token){
        await signInWithCustomToken(auth, __initial_auth_token);
      }else{
        await signInAnonymously(auth);
      }
    }catch(e){
      console.error('Firebase auth error',e);
    }
  }

  /* ------------------ Firestore 실시간 구독 ------------------ */
  function subscribeOnlineData(){
    onSnapshot(docRef,(snap)=>{
      if(snap.exists()){
        onlineData = snap.data();
      }else{
        // 문서 없으면 초기 생성
        const base={};
        teamMembers.forEach(m=>{
          base[m]={};
          Object.keys(sections).forEach(k=>base[m][k]=false);
          if(SHARE_CHECK_COUNTS){ base[m].checkCount=0; base[m].checkTotal=TOTAL_CHECK_ITEMS; }
        });
        setDoc(docRef,base).catch(e=>console.error('init doc fail',e));
        onlineData = base;
      }
      renderOnlineTable(onlineData);
    },(err)=>{
      console.error('snapshot error',err);
      confirmationContainer.innerHTML
